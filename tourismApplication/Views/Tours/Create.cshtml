@model tourismApplication.Models.Tour
@{
    ViewData["Title"] = "Plan Your Tour";
    var locs = ViewBag.Locations as IEnumerable<dynamic>;
}

<div class="d-flex justify-content-center mt-4">
    <div class="card shadow-sm p-4" style="width: 500px;">
        <h2 class="text-center mb-4"><i class="bi bi-geo-alt-fill me-2"></i>Plan Your Tour</h2>

        <form asp-action="Create" id="plannerForm">

            <input type="hidden" asp-for="Title" id="hiddenTitle" />
            <input type="hidden" asp-for="PricePerDay" id="pricePerDay" />

            <!-- Location -->
            <div class="mb-3">
                <label class="form-label fw-semibold">Location</label>
                <select id="location" class="form-select">
                    <option value="">-- Select a location --</option>
                    @foreach (var l in (locs ?? Enumerable.Empty<dynamic>()))
                    {
                        <option value="@l.Name"
                                data-price="@l.PricePerDay"
                                data-limit="@l.GroupLimit"
                                data-from="@l.From.ToString("yyyy-MM-dd")"
                                data-to="@l.To.ToString("yyyy-MM-dd")">
                            @l.Name (@l.PricePerDay.ToString("C")/day, limit @l.GroupLimit)
                        </option>
                    }
                </select>
                <div class="form-text">Price is per person per day.</div>
            </div>

            <!-- Dates -->
            <div class="row g-3 mb-3">
                <div class="col">
                    <label asp-for="AvailableFrom" class="form-label fw-semibold">Start Date</label>
                    <input asp-for="AvailableFrom" type="date" class="form-control" id="from" />
                </div>
                <div class="col">
                    <label asp-for="AvailableTo" class="form-label fw-semibold">End Date</label>
                    <input asp-for="AvailableTo" type="date" class="form-control" id="to" />
                </div>
            </div>

            <!-- Image URL -->
            <div class="mb-3">
                <label asp-for="ImageUrl" class="form-label fw-semibold">Tour Image URL</label>
                <input asp-for="ImageUrl" class="form-control" placeholder="Enter image URL" />
                <span asp-validation-for="ImageUrl" class="text-danger"></span>
            </div>

            <!-- People & Duration -->
            <div class="row g-3 mb-3">
                <div class="col">
                    <label asp-for="PeopleCount" class="form-label fw-semibold">No. of People</label>
                    <input asp-for="PeopleCount" class="form-control" id="people" type="number" min="1" value="1" />
                    <span asp-validation-for="PeopleCount" class="text-danger"></span>
                </div>
                <div class="col">
                    <label asp-for="DurationDays" class="form-label fw-semibold">Duration (Days)</label>
                    <input asp-for="DurationDays" class="form-control" id="days" readonly />
                </div>
            </div>

            <!-- Price & Limit -->
            <div class="row g-3 mb-4">
                <div class="col">
                    <label asp-for="Price" class="form-label fw-semibold">Total Price</label>
                    <input asp-for="Price" class="form-control" id="totalPrice" readonly />
                </div>
                <div class="col">
                    <label asp-for="GroupSizeLimit" class="form-label fw-semibold">Group Limit</label>
                    <input asp-for="GroupSizeLimit" class="form-control" id="limit" readonly />
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary w-45"><i class="bi bi-check-circle me-2"></i>Save</button>
                <a asp-action="Index" class="btn btn-secondary w-45"><i class="bi bi-x-circle me-2"></i>Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const sel = document.getElementById('location');
        const from = document.getElementById('from');
        const to   = document.getElementById('to');
        const people = document.getElementById('people');
        const days = document.getElementById('days');
        const totalPrice = document.getElementById('totalPrice');
        const limit = document.getElementById('limit');
        const hiddenTitle = document.getElementById('hiddenTitle');
        const pricePerDayInput = document.getElementById('pricePerDay');

        function diffDays(a, b){
          if(!a || !b) return 0;
          const ms = (new Date(b)) - (new Date(a));
          return Math.floor(ms / (1000*60*60*24)) + 1;
        }

        function calc(){
          const opt = sel.options[sel.selectedIndex];
          const loc = opt?.value || '';
          const pricePerDay = parseFloat(opt?.dataset.price || '0');
          const max = parseInt(opt?.dataset.limit || '0');

          hiddenTitle.value = loc;
          pricePerDayInput.value = pricePerDay || 0;
          limit.value = max || '';

          const d = diffDays(from.value, to.value);
          days.value = d > 0 ? d : '';

          const count = parseInt(people.value || '0');
          const total = (d > 0 && count > 0) ? (pricePerDay * d * count) : 0;
          totalPrice.value = total.toFixed(2);
        }

        sel.addEventListener('change', calc);
        from.addEventListener('change', calc);
        to.addEventListener('change', calc);
        people.addEventListener('input', calc);
        document.getElementById('plannerForm').addEventListener('submit', function(){ calc(); });

        calc();
    </script>
} 
